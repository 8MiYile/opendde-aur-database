build() {
	cd "$srcdir/h2o"

	patch -p1 -i "$srcdir/deps.patch"

	# set CMake minimal version to 3.9 to set CMP0039 to new
	sed -i 's/VERSION 2.8.11/VERSION 3.9/g' CMakeLists.txt

	rm -rf deps/brotli
	mv "$srcdir/brotli-$bver" deps/brotli

	rm -rf deps/yaml

	rm -rf deps/libyrmcds
	mv "$srcdir/libyrmcds-$yrver" deps/libyrmcds

	rm -rf deps/hiredis
	mv "$srcdir/hiredis-$rver" deps/hiredis

	patch -p1 -i "$srcdir/h2o-hiredis.patch"

	sed -i 's|example|/usr/share/doc/h2o/example|' examples/h2o/h2o.conf

	# Note that picotls can be turned off,
	# OpenSSL already supports TLS 1.3
	cmake \
		-DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=/usr/lib \
		-DCMAKE_INSTALL_SYSCONFDIR=/etc \
		-DWITH_MRUBY=off \
		-DWITHOUT_LIBS=off \
		-DBUILD_SHARED_LIBS=off \
		.

	make
}
