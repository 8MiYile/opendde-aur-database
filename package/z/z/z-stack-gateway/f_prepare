prepare() {
  msg2 "Unpacking bitrock installer..."
  bitrock-unpacker Z-Stack_Linux_Gateway-${_under_pkgver}-src-linux-installer.run ./unpacked.vfs

  # now we'll fix up the source code
  sed -i 's,export PROTOINC=$SCRIPTPATH,export '"PROTOINC=${srcdir}/protobuf-install-root/include"',g' "${srcdir}/unpacked.vfs/default/programfileslinux/Source/build_all"
  sed -i 's,export PROTOLIB=$SCRIPTPATH/protobuf-c-arm/lib,export '"PROTOLIB=${srcdir}/protobuf-install-root/lib"',g' "${srcdir}/unpacked.vfs/default/programfileslinux/Source/build_all"
  sed -i 's,export TARGET_PLATFORM="BEAGLEBONE_BLACK",export TARGET_PLATFORM="x86",g' "${srcdir}/unpacked.vfs/default/programfileslinux/Source/scripts/package_builder_bbb"
  sed -i 's,make arch-all-armBeagleBone CC_armBeagleBone=$COMPILER |& tee -a $MAKE_LOG_FILE,make $BUILD_TYPE |\& tee -a $MAKE_LOG_FILE,g' "${srcdir}/unpacked.vfs/default/programfileslinux/Source/scripts/package_builder_bbb"
  sed -i 's,cp $NPI_SOURCE/Projects/tools/LinuxHost/out/NPI_lnx_armBeagleBone_server $BINARIES_SERVERS_DIR/NPI_lnx_${PLATFORM_SUBSTRING}_server,cp $NPI_SOURCE/Projects/tools/LinuxHost/out/NPI_lnx_${PLATFORM_SUBSTRING}_server $BINARIES_SERVERS_DIR/NPI_lnx_${PLATFORM_SUBSTRING}_server,g' "${srcdir}/unpacked.vfs/default/programfileslinux/Source/scripts/package_builder_bbb"


  sed -i 's,COMPILO_FLAGS_x86 = "-O0 -g3 -Wall $(INCLUDES) $(DEFINES) -include ../hal/hal_types.h -include f8wConfig.h",COMPILO_FLAGS_x86 = "-O0 -g3 -Wall $(INCLUDES) $(DEFINES) -include ../hal/hal_types.h -include f8wConfig.h -I $(PROTOC_INC_DIR)",g' "${srcdir}/unpacked.vfs/default/programfileslinux/Source/Projects/zstack/linux/zstackserverznp/Makefile"
  sed -i 's,COMPILO_FLAGS_x86 = "-Wall $(INCLUDES) $(DEFINES) -include ../hal/hal_types.h",COMPILO_FLAGS_x86 = "-Wall $(INCLUDES) $(DEFINES) -include ../hal/hal_types.h -I $(PROTOC_INC_DIR)",g' "${srcdir}/unpacked.vfs/default/programfileslinux/Source/Projects/zstack/linux/nwkmgr/Makefile"
  sed -i 's,COMPILO_FLAGS_x86 = "-Wall $(INCLUDES) $(DEFINES) -include ../hal/hal_types.h",COMPILO_FLAGS_x86 = "-Wall $(INCLUDES) $(DEFINES) -include ../hal/hal_types.h -I $(PROTOC_INC_DIR)",g' "${srcdir}/unpacked.vfs/default/programfileslinux/Source/Projects/zstack/linux/hagateway/Makefile"
  sed -i 's,COMPILO_FLAGS_x86 = " -g -Wall $(INCLUDES) $(DEFINES) -include hal_types.h -include AF.h -include zcl.h -include zcl_ota.h ",COMPILO_FLAGS_x86 = " -g -Wall $(INCLUDES) $(DEFINES) -include hal_types.h -include AF.h -include zcl.h -include zcl_ota.h -I $(PROTOC_INC_DIR)",g' "${srcdir}/unpacked.vfs/default/programfileslinux/Source/Projects/zstack/linux/otaserver/Makefile"
}
