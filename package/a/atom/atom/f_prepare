prepare() {
	cd "$_archive"
	patch -Np1 -i ../fix-$pkgname-sh.patch
	patch -Np1 -i <(sed -e "s/@ELECTRON@/$_electron/" ../use-system-electron.patch)
	patch -Np1 -i ../use-system-apm.patch
	patch -Np1 -i ../fix-license-path.patch
	patch -Np1 -i ../fix-restart.patch
	patch -Np1 -i ../node-env-production.patch
	patch -Np1 -i ../no-unsafe-eval-warning.patch

	CXXFLAGS="${CXXFLAGS/ -fexceptions/}"
	env \
		ATOM_RESOURCE_PATH="$PWD" ATOM_HOME="$srcdir/.atom" \
		npm_config_build_from_source=true \
		npm_config_target=$_electron_version \
		GYP_DEFINES="openssl_fips=" \
		apm install --cache "$srcdir/npm-cache"

	# Use system ctags
	pushd node_modules/symbols-view
	patch -Np1 -i "$srcdir/symbols-view-use-system-ctags.patch"
	rm -r lib/ctags-config vendor
	popd

	# Use system git
	pushd node_modules/dugite
	patch -Np1 -i "$srcdir/dugite-use-system-git.patch"
	rm -r git
	popd

	# Fix issue with:
	# build/Release/git.node: undefined symbol: git_net_url_is_default_port
	pushd node_modules/git-utils
	patch -Np1 -i "$srcdir/git-utils.patch"
	popd

	pushd script
	npm install --cache "$srcdir/npm-cache"
}
