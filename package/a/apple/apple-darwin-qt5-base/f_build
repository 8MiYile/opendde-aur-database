build() {
  cd "${srcdir}/${_pkgfqn}"

  # Do not set any flags here, flags are configured via mkspec
  # Setting flags here is not appropriate as it does not allow to
  # distinguish between flags for native compiler and cross compiler
  unset CFLAGS
  unset CXXFLAGS
  unset LDFLAGS
  unset PKG_CONFIG_PATH

  init_osxcross

  for _arch in ${_architectures}; do
    # To prevent conflicts with the mingw-w64-qt4 package we have
    # to put tools in a dedicated folder

    # The last device option allows using ccache though the use of
    # pre-compile header
    # (sloppiness must be set to pch_defines,time_macros in ccache config)

    # For simplicity, this package only includes a static build so far
    # (no 2 variants like mingw-w64-qt5-base/mingw-w64-qt5-base-static available)

    # It uses the native MacOS API ("-securetransport") rather than OpenSSL

    # MySQL and PostgreSQL are disabled, because needed packages are not available
    # yet, for the same reason bundled freetype2 and harfbuzz are used

    local qt_configure_args="\
      -static \
      -xplatform macx-clang \
      -securetransport \
      -optimized-qmake \
      -verbose \
      -opensource \
      -confirm-license \
      -force-debug-info \
      -sql-sqlite \
      -no-glib \
      -no-icu \
      -nomake examples \
      -make tools \
      -hostprefix ${_osxcrossprefix}/${_arch} \
      -hostdatadir ${_osxcrossprefix}/${_arch}/lib/qt \
      -hostbindir ${_osxcrossprefix}/${_arch}/lib/qt/bin \
      -prefix ${_osxcrossprefix}/${_arch} \
      -bindir ${_osxcrossprefix}/${_arch}/bin \
      -archdatadir ${_osxcrossprefix}/${_arch}/lib/qt \
      -datadir ${_osxcrossprefix}/${_arch}/share/qt \
      -docdir ${_osxcrossprefix}/${_arch}/share/doc/qt \
      -examplesdir ${_osxcrossprefix}/${_arch}/share/qt/examples \
      -headerdir ${_osxcrossprefix}/${_arch}/include/qt \
      -libdir ${_osxcrossprefix}/${_arch}/lib \
      -plugindir ${_osxcrossprefix}/${_arch}/lib/qt/plugins \
      -sysconfdir ${_osxcrossprefix}/${_arch}/etc \
      -translationdir ${_osxcrossprefix}/${_arch}/share/qt/translations \
      QMAKE_APPLE_DEVICE_ARCHS=${_arch%%-*} \
      QMAKE_MACOSX_DEPLOYMENT_TARGET=10.5 \
      -device-option CROSS_COMPILE=${_arch}- \
      -device-option QMAKE_MACOSX_STDLIB=libstdc++ \
      -device-option CROSS_COMPILE_CFLAGS=-fpch-preprocess"

    # Disable debug build (unless APPLE_DARWIN_QT_DEBUG_BUILD is defined)
    [[ $APPLE_DARWIN_QT_DEBUG_BUILD ]] \
      && qt_configure_args+=' -debug_and_release' \
      || qt_configure_args+=' -release'

    mkdir -p ../build-${_arch} && pushd ../build-${_arch}
    ../${_pkgfqn}/configure $qt_configure_args
    make
    popd
  done
}
