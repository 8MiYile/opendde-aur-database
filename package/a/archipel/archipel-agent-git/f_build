build() {
  # Remove central agent python packages
  rm "$srcdir"/Archipel/ArchipelAgent/archipel-central-agent* -r 2>/dev/null

  _list=$(find "$srcdir"/Archipel/ArchipelAgent -type d -name "archipel-*")
  for _dir in $_list; do
    msg "Building $_dir"
    pushd $_dir 1>/dev/null
    if [ -f 'setup.py' ]; then
      python2 setup.py install --root="$srcdir/$pkgname" --optimize=1 1>/dev/null
    fi
    popd 1>/dev/null
  done;

  # Replace python with python2
  sed -i 's/\/usr\/bin\/python /\/usr\/bin\/python2 /' "$srcdir"/"$pkgname"/usr/bin/*

  # Copy modules.d conf files
  _list=$(find "$srcdir"/"$pkgname"/usr/lib/ -type d -name '*.egg-info')
  for _pack in $_list; do
    _conf=$(cat "$_pack"/SOURCES.txt | sed -nr '/plugin.conf/p')
    if [ -n "$_conf" ]; then
      _name=$(cat "$_pack"/PKG-INFO | sed -n '/Name:/p' | sed -n -e 's/^.*\(agent-\)\(.*\)$/\2/p')
      install -Dm644 "$_pack"/../"$_conf" "$srcdir"/"$pkgname"/usr/install/etc/archipel/modules.d/"$_name".conf
    fi
  done;

  # Remove old init.d
  rm "$srcdir"/"$pkgname"/usr/install/etc/init.d -r
}
