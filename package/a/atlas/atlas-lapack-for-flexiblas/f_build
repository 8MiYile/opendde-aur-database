build() {
   msg 'Before building this package, as root you must set the CPU(s)'
   msg 'governor(s) to "performance".'
   msg 'See: https://wiki.archlinux.org/index.php/CPU_frequency_scaling'

   cd "$srcdir"
   tar -xjf atlas$pkgver.tar.bz2

   unset MAKE
   CORE=`cat /proc/cpuinfo | grep "cpu MHz" | head -n 1 | sed "s/.*: \([0-9.]*\).*/\1/"`
   NCPU=`grep "^processor" /proc/cpuinfo | wc -l`
   if [ "$CARCH" = "x86_64" ]; then
      ARCHITECTURE_BUILD_OPTS="-b 64" # for x86_64
   else
      ARCHITECTURE_BUILD_OPTS="-b 32" # for i686
   fi

   cd "$srcdir"/ATLAS
   rm -rf build
   mkdir -p build
   cd build

   msg 'Configuring ATLAS'

   ../configure --prefix=/usr/ $ARCHITECTURE_BUILD_OPTS -Fa alg -fPIC \
      --shared -D c -DPentiumCPS=$CORE \
      --with-netlib-lapack-tarfile="$srcdir/lapack-$_lapackver.tgz"

   msg 'Building ATLAS'

   make build

   msg 'Building shared libraries'
   cd lib
   if [ 1 -lt $NCPU ]; then
      cp "$srcdir/makefile.shared.mt" makefile
   else
      cp "$srcdir/makefile.shared.st" makefile
   fi
   make -f makefile
}
